<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–¥–º–∏–Ω–∫–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
    body {
      padding: 20px;
      background: #f5f7fa;
      color: #222;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h2 { margin: 20px 0 12px; }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      background: #2196F3;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    button.export-btn {
      background: #9c27b0;
      font-size: 14px;
      padding: 8px;
    }
    .section { background: white; padding: 16px; border-radius: 12px; margin-top: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .hidden { display: none !important; }
    .promo-alert {
      padding: 14px;
      border-radius: 8px;
      margin: 16px 0;
      font-weight: bold;
      text-align: center;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .level-20 { background: #e3f2fd; color: #0d47a1; }
    .level-25 { background: #fff8e1; color: #e65100; }
    .level-30 { background: #e8f5e8; color: #1b5e20; }
    .footer-note { text-align: center; font-size: 12px; color: #888; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéüÔ∏è –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</h1>

    <!-- –ù–û–í–´–ô –ö–õ–ò–ï–ù–¢ -->
    <div class="section">
      <h2>‚ûï –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</h2>
      <button onclick="generateNewUser()">–í—ã–¥–∞—Ç—å QR —Å 100 –±–∞–ª–ª–∞–º–∏</button>
      <div id="new-qr-display" class="hidden">
        <h3>QR –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:</h3>
        <div id="new-qr-img"></div>
      </div>
    </div>

    <!-- –ù–ê–ß–ò–°–õ–ï–ù–ò–ï –ë–ê–õ–õ–û–í -->
    <div class="section">
      <h2>üîÑ –ù–∞—á–∏—Å–ª–∏—Ç—å 5 –±–∞–ª–ª–æ–≤</h2>
      <input type="text" id="input-qr-full" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É –∏–∑ QR-–∫–æ–¥–∞" />
      <button onclick="addPointsAutomatically()">–î–æ–±–∞–≤–∏—Ç—å 5 –±–∞–ª–ª–æ–≤</button>

      <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ü–†–û–ú–û–ö–û–î–ï -->
      <div id="promo-notification" class="hidden"></div>

      <!-- –û–ë–ù–û–í–õ–Å–ù–ù–´–ô QR -->
      <div id="result-qr-display" class="hidden">
        <h3>–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π QR:</h3>
        <div id="result-qr-img"></div>
      </div>
    </div>

    <!-- –≠–ö–°–ü–û–†–¢ –ò–°–¢–û–†–ò–ò (–ú–ò–ù–ò–ú–ê–õ–¨–ù–û) -->
    <div style="text-align:center; margin-top:20px;">
      <button class="export-btn" onclick="exportHistory()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏</button>
    </div>

    <div class="footer-note">
      –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.
    </div>
  </div>

  <!-- QR Generator -->
  <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
  <script>
    // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
    const SECRET = "loyalty-secret-2026"; // ‚Üê –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô!

    // –ò—Å—Ç–æ—Ä–∏—è
    let history = JSON.parse(localStorage.getItem('loyalty_history') || '[]');

    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function makeHash(id, points) {
      return btoa(`${id}|${points}|${SECRET}`).replace(/[^a-zA-Z0-9]/g, '').substring(0, 12).toUpperCase();
    }

    function verifyData(id, points, hash) {
      return makeHash(id, points) === hash;
    }

    function encodeToQRString(id, points) {
      return `id:${id}|points:${points}|hash:${makeHash(id, points)}`;
    }

    function parseQRString(str) {
      const data = {};
      str.split('|').forEach(part => {
        const [k, v] = part.split(':');
        if (k && v) data[k] = k === 'points' ? parseInt(v) : v;
      });
      return data;
    }

    function generateQRImage(str) {
      const qr = qrcode(0, 'M');
      qr.addData(str);
      qr.make();
      return qr.createImgTag(6);
    }

    // === –ó–í–£–ö ===
    function playSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        oscillator.frequency.value = 800; // —á–∞—Å—Ç–æ—Ç–∞
        gainNode.gain.value = 0.2;
        oscillator.type = 'sine';
        oscillator.start();
        setTimeout(() => {
          oscillator.stop();
        }, 200);
      } catch (e) {
        console.warn("–ó–≤—É–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", e);
      }
    }

    // === –ò–°–¢–û–†–ò–Ø ===
    function addToHistory(id, oldPoints, newPoints) {
      history.unshift({
        time: new Date().toISOString(),
        id,
        oldPoints,
        newPoints
      });
      if (history.length > 500) history = history.slice(0, 500);
      localStorage.setItem('loyalty_history', JSON.stringify(history));
    }

    function exportHistory() {
      let txt = "–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤\n=========================\n\n";
      history.forEach(item => {
        const date = new Date(item.time).toLocaleString('ru-RU');
        txt += `${date} | ID: ${item.id} | ${item.oldPoints} ‚Üí ${item.newPoints}\n`;
      });
      const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `loyalty_history_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function generateNewUser() {
      const id = Math.random().toString(36).substring(2, 10) + Date.now().toString(36).slice(-4);
      const points = 100;
      const qrStr = encodeToQRString(id, points);
      document.getElementById('new-qr-img').innerHTML = generateQRImage(qrStr);
      document.getElementById('new-qr-display').classList.remove('hidden');
      addToHistory(id, 0, points);
    }

    function addPointsAutomatically() {
      const fullStr = document.getElementById('input-qr-full').value.trim();
      if (!fullStr) return alert("–í—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É –∏–∑ QR-–∫–æ–¥–∞");

      const data = parseQRString(fullStr);
      if (!data.id || isNaN(data.points) || !data.hash) {
        return alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR");
      }

      if (!verifyData(data.id, data.points, data.hash)) {
        return alert("‚ùå –ü–æ–¥–¥–µ–ª—å–Ω—ã–π QR!");
      }

      const added = 5;
      const newPoints = data.points + added;

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
      addToHistory(data.id, data.points, newPoints);

      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ QR
      const newQrStr = encodeToQRString(data.id, newPoints);
      document.getElementById('result-qr-img').innerHTML = generateQRImage(newQrStr);
      document.getElementById('result-qr-display').classList.remove('hidden');

      // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–º–æ–∫–æ–¥–µ
      const promoDiv = document.getElementById('promo-notification');
      promoDiv.className = 'promo-alert hidden';

      let level = null, discount = 0;
      if (newPoints >= 100) {
        level = '30'; discount = 30;
      } else if (newPoints >= 75) {
        level = '25'; discount = 25;
      } else if (newPoints >= 50) {
        level = '20'; discount = 20;
      }

      if (level) {
        promoDiv.innerText = `üéÅ –î–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ ${discount}% —Å–∫–∏–¥–∫—É!`;
        promoDiv.classList.add(`level-${level}`);
        promoDiv.classList.remove('hidden');
        playSound(); // üîä –∑–≤—É–∫!
      }

      // –û—á–∏—Å—Ç–∫–∞
      document.getElementById('input-qr-full').value = '';
    }
  </script>
</body>
</html>
