<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Лояльность</title>
  <style>/* ... минималистичный стиль ... */</style>
</head>
<body>

<!-- Основной виджет для клиента -->
<div id="client-view">
  <h2>Ваш телефон:</h2>
  <input id="phone" placeholder="+7..." />
  <button onclick="showQR()">Получить QR</button>
  <div id="qr-code"></div>
</div>

<!-- Админка (скрыта по умолчанию) -->
<div id="admin-panel" style="display:none;">
  <h2>Админка</h2>
  <input id="admin-pin" type="password" placeholder="PIN" />
  <button onclick="unlockAdmin()">Войти</button>
  
  <div id="admin-content" style="display:none;">
    <video id="camera" autoplay></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <button onclick="startScan()">Сканировать QR</button>
    <div id="scan-result"></div>
    
    <div id="user-info" style="display:none;">
      <p>Телефон: <span id="user-phone"></span></p>
      <p>Баллы: <span id="user-points"></span></p>
      <input id="points-change" type="number" placeholder="± баллы" />
      <button onclick="applyPoints()">Применить</button>
    </div>
  </div>
</div>

<!-- Переключатель -->
<button onclick="toggleMode()">Админка / Клиент</button>

<script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
<script>
// === ДАННЫЕ ===
const ADMINS = ["1234"]; // PIN для входа в админку
let users = JSON.parse(localStorage.getItem('loyalty_users') || '{}');

// === КЛИЕНТСКАЯ ЧАСТЬ ===
function showQR() {
  const phone = document.getElementById('phone').value.trim();
  if (!phone) return alert("Введите телефон");
  
  // Сохраняем пользователя, если нового
  if (!users[phone]) {
    users[phone] = { points: 0, id: Date.now().toString(36) };
    saveUsers();
  }
  
  const userId = users[phone].id;
  const qrData = `LOYALTY:${userId}`; // формат: LOYALTY:abc123
  
  // Генерация QR
  const qr = qrcode(0, 'M');
  qr.addData(qrData);
  qr.make();
  document.getElementById('qr-code').innerHTML = qr.createImgTag(5);
}

// === АДМИНКА ===
function toggleMode() {
  const client = document.getElementById('client-view');
  const admin = document.getElementById('admin-panel');
  client.style.display = client.style.display === 'none' ? 'block' : 'none';
  admin.style.display = admin.style.display === 'none' ? 'block' : 'none';
}

function unlockAdmin() {
  const pin = document.getElementById('admin-pin').value;
  if (ADMINS.includes(pin)) {
    document.getElementById('admin-content').style.display = 'block';
    startCamera();
  } else {
    alert("Неверный PIN");
  }
}

// === КАМЕРА + СКАНИРОВАНИЕ QR ===
let scannerActive = false;
async function startCamera() {
  const video = document.getElementById('camera');
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  video.srcObject = stream;
}

async function startScan() {
  if (scannerActive) return;
  scannerActive = true;
  const video = document.getElementById('camera');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  
  const scanInterval = setInterval(() => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Простой способ: использовать внешнюю библиотеку (но она увеличит размер)
    // В упрощённой версии — вручную ввод ID или использовать input
    
    // Альтернатива: отключим камеру и будем вводить ID вручную (для простоты и совместимости)
    clearInterval(scanInterval);
    scannerActive = false;
    alert("Сканирование пока недоступно. Введите ID вручную.");
  }, 500);
}

// === РУЧНОЙ ВВОД ID (резерв) ===
// Можно добавить поле: <input id="manual-id"> + кнопка "Найти"

// === УПРАВЛЕНИЕ БАЛЛАМИ ===
function findUserById(id) {
  for (let phone in users) {
    if (users[phone].id === id) return { phone, ...users[phone] };
  }
  return null;
}

function applyPoints() {
  const change = parseInt(document.getElementById('points-change').value);
  const phone = document.getElementById('user-phone').innerText;
  if (!users[phone]) return;
  
  users[phone].points += change;
  if (users[phone].points < 0) users[phone].points = 0;
  
  saveUsers();
  document.getElementById('user-points').innerText = users[phone].points;
  alert(`Баллы обновлены!`);
}

function saveUsers() {
  localStorage.setItem('loyalty_users', JSON.stringify(users));
}

// === ЗАГРУЗКА ===
window.onload = () => {
  // Скрыть админку при старте
  document.getElementById('admin-panel').style.display = 'none';
};
</script>

</body>
</html>
