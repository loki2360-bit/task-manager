<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–¥–º–∏–Ω–∫–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
    body {
      padding: 20px;
      background: #f5f7fa;
      color: #222;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h2 { margin: 20px 0 12px; }
    input, button, select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      background: #2196F3;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .settings-grid input, .settings-grid label {
      width: 100%;
      margin: 0;
      font-size: 14px;
    }
    button.export-btn { background: #9c27b0; font-size: 14px; padding: 8px; }
    button.send-btn { background: #0088cc; }
    button.print-btn { background: #4CAF50; }
    button.reset-btn { background: #f44336; }
    button.settings-btn { background: #607D8B; }
    .section { background: white; padding: 16px; border-radius: 12px; margin-top: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .hidden { display: none !important; }
    .promo-alert {
      padding: 14px;
      border-radius: 8px;
      margin: 16px 0;
      font-weight: bold;
      text-align: center;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .level-5 { background: #e3f2fd; color: #0d47a1; }
    .level-20 { background: #fff8e1; color: #e65100; }
    .level-30 { background: #e8f5e8; color: #1b5e20; }
    .pin-display {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: #2196F3;
    }
    .footer-note { text-align: center; font-size: 12px; color: #888; margin-top: 20px; }

    @media print {
      body { background: white; padding: 0; }
      .container { max-width: 100%; margin: 0; }
      .no-print { display: none !important; }
      #print-area {
        text-align: center;
        padding: 20px;
      }
      #print-area img {
        max-width: 300px;
        margin: 0 auto;
      }
      h1 { font-size: 24px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéüÔ∏è –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</h1>

    <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
    <div class="section no-print">
      <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <p>–ë–∞–ª–ª—ã –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏—é:</p>
      <input type="number" id="points-per-op" min="1" max="100" value="5" />

      <p>–£—Ä–æ–≤–Ω–∏ —Å–∫–∏–¥–æ–∫:</p>
      <div class="settings-grid">
        <div>
          <label>15 –±–∞–ª–ª–æ–≤ ‚Üí</label>
          <input type="number" id="disc1" min="0" max="100" value="5" placeholder="%"/>%
        </div>
        <div>
          <label>25 –±–∞–ª–ª–æ–≤ ‚Üí</label>
          <input type="number" id="disc2" min="0" max="100" value="20" placeholder="%"/>%
        </div>
        <div>
          <label>30 –±–∞–ª–ª–æ–≤ ‚Üí</label>
          <input type="number" id="disc3" min="0" max="100" value="30" placeholder="%"/>%
        </div>
      </div>
      <button class="settings-btn" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <!-- –ù–û–í–´–ô –ö–õ–ò–ï–ù–¢ -->
    <div class="section">
      <h2>‚ûï –ù–æ–≤–∞—è –∫–∞—Ä—Ç–∞</h2>
      <input type="text" id="contact-link" placeholder="Telegram (@user) –∏–ª–∏ VK (https://vk.com/user)" />
      <button onclick="generateNewUser()">–í—ã–¥–∞—Ç—å –∫–∞—Ä—Ç—É</button>
      <div id="new-qr-display" class="hidden">
        <div class="pin-display">PIN: <span id="new-pin"></span></div>
        <h3>QR –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:</h3>
        <div id="new-qr-img"></div>
        <button class="send-btn" onclick="sendToClient('new')">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button class="print-btn no-print" onclick="printQR('new')">üñ®Ô∏è –ü–µ—á–∞—Ç—å —á–µ–∫–∞</button>
      </div>
    </div>

    <!-- –ù–ê–ß–ò–°–õ–ï–ù–ò–ï –ë–ê–õ–õ–û–í -->
    <div class="section">
      <h2>üîÑ –ù–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π PIN –∫–ª–∏–µ–Ω—Ç–∞:</p>
      <input type="text" id="input-pin" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 48291" maxlength="5" />
      <button onclick="addPointsByPin()">–ù–∞—á–∏—Å–ª–∏—Ç—å</button>
      <button class="reset-btn no-print" onclick="resetPoints()">üîÑ –û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–ª—ã</button>

      <div id="promo-notification" class="hidden"></div>

      <div id="result-qr-display" class="hidden">
        <h3>–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π QR:</h3>
        <div id="result-qr-img"></div>
        <button class="send-btn" onclick="sendToClient('result')">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button class="print-btn no-print" onclick="printQR('result')">üñ®Ô∏è –ü–µ—á–∞—Ç—å —á–µ–∫–∞</button>
      </div>
    </div>

    <!-- –≠–ö–°–ü–û–†–¢ -->
    <div style="text-align:center; margin-top:20px;" class="no-print">
      <button class="export-btn" onclick="exportHistory()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏</button>
    </div>

    <div class="footer-note no-print">
      –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.
    </div>
  </div>

  <div id="print-area" class="hidden">
    <h1>–í–∞—à–∞ –∫–∞—Ä—Ç–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</h1>
    <div id="print-qr-container"></div>
    <p style="margin-top:20px; font-size:14px;">–ü—Ä–µ–¥—ä—è–≤–∏—Ç–µ QR-–∫–æ–¥ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ.</p>
  </div>

  <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
  <script>
    // === –ó–ê–ì–†–£–ó–ö–ê –ù–ê–°–¢–†–û–ï–ö ===
    let settings = JSON.parse(localStorage.getItem('loyalty_settings')) || {
      pointsPerOp: 5,
      levels: [
        { threshold: 15, discount: 5 },
        { threshold: 25, discount: 20 },
        { threshold: 30, discount: 30 }
      ]
    };

    let history = JSON.parse(localStorage.getItem('loyalty_history') || '[]');
    let currentContactLink = null;
    let currentPin = null;

    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ UI –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('points-per-op').value = settings.pointsPerOp;
      document.getElementById('disc1').value = settings.levels[0].discount;
      document.getElementById('disc2').value = settings.levels[1].discount;
      document.getElementById('disc3').value = settings.levels[2].discount;
    });

    function saveSettings() {
      settings.pointsPerOp = parseInt(document.getElementById('points-per-op').value) || 5;
      settings.levels[0].discount = parseInt(document.getElementById('disc1').value) || 5;
      settings.levels[1].discount = parseInt(document.getElementById('disc2').value) || 20;
      settings.levels[2].discount = parseInt(document.getElementById('disc3').value) || 30;
      localStorage.setItem('loyalty_settings', JSON.stringify(settings));
      alert("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
    }

    // === –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫—Ä–æ–º–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è settings) ===
    function generateUniquePin() {
      let pin;
      do {
        pin = Math.floor(10000 + Math.random() * 90000).toString();
      } while (history.some(h => h.pin === pin));
      return pin;
    }

    function makeHash(id, points) {
      const SECRET = "loyalty-secret-2026";
      return btoa(`${id}|${points}|${SECRET}`).replace(/[^a-zA-Z0-9]/g, '').substring(0, 12).toUpperCase();
    }

    function encodeToQRString(id, points) {
      return `id:${id}|points:${points}|hash:${makeHash(id, points)}`;
    }

    function generateQRImage(str) {
      const qr = qrcode(0, 'M');
      qr.addData(str);
      qr.make();
      return qr.createImgTag(6);
    }

    function playSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        oscillator.frequency.value = 800;
        gainNode.gain.value = 0.2;
        oscillator.type = 'sine';
        oscillator.start();
        setTimeout(() => oscillator.stop(), 200);
      } catch (e) {}
    }

    function addToHistory(id, oldPoints, newPoints, contact = '', pin = '') {
      history.unshift({ time: new Date().toISOString(), id, oldPoints, newPoints, contact, pin });
      if (history.length > 500) history = history.slice(0, 500);
      localStorage.setItem('loyalty_history', JSON.stringify(history));
    }

    function exportHistory() {
      let txt = "–ò—Å—Ç–æ—Ä–∏—è\n=======\n\n";
      history.forEach(item => {
        const date = new Date(item.time).toLocaleString('ru-RU');
        txt += `${date} | PIN: ${item.pin} | ${item.contact || '‚Äî'} | ID: ${item.id} | ${item.oldPoints} ‚Üí ${item.newPoints}\n`;
      });
      const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `loyalty_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function saveQRAsFile(imgElement) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const img = new Image();
      img.src = imgElement.src;
      
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `loyalty_qr_${new Date().getTime()}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 'image/png');
      };
    }

    function sendToClient(type) {
      const imgElement = document.querySelector(`#${type}-qr-img img`);
      if (!imgElement) return alert("QR –Ω–µ –Ω–∞–π–¥–µ–Ω");
      saveQRAsFile(imgElement);

      if (currentContactLink) {
        let url = '';
        if (currentContactLink.startsWith('@')) {
          const username = currentContactLink.replace(/^@/, '');
          url = `https://t.me/${username}`;
        } else if (currentContactLink.includes('vk.com')) {
          const vkId = currentContactLink.split('/').pop();
          url = `https://vk.com/im?sel=${vkId}`;
        }
        if (url) window.open(url, '_blank');
      }

      setTimeout(() => {
        alert("‚úÖ QR —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ —Ñ–∞–π–ª!\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –∫–ª–∏–µ–Ω—Ç—É.");
      }, 300);
    }

    function printQR(type) {
      const imgElement = document.querySelector(`#${type}-qr-img img`);
      if (!imgElement) return alert("QR –Ω–µ –Ω–∞–π–¥–µ–Ω");

      const printContainer = document.getElementById('print-qr-container');
      printContainer.innerHTML = '';
      const clone = imgElement.cloneNode(true);
      printContainer.appendChild(clone);
      document.getElementById('print-area').classList.remove('hidden');

      setTimeout(() => {
        window.print();
        document.getElementById('print-area').classList.add('hidden');
      }, 300);
    }

    function generateNewUser() {
      const contact = document.getElementById('contact-link').value.trim();
      if (!contact) return alert("–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç");

      currentContactLink = contact;
      const id = Math.random().toString(36).substring(2, 10) + Date.now().toString(36).slice(-4);
      const pin = generateUniquePin();
      const points = 5;
      const qrStr = encodeToQRString(id, points);

      document.getElementById('new-pin').innerText = pin;
      document.getElementById('new-qr-img').innerHTML = generateQRImage(qrStr);
      document.getElementById('new-qr-display').classList.remove('hidden');

      addToHistory(id, 0, points, contact, pin);
    }

    function addPointsByPin() {
      const pinInput = document.getElementById('input-pin').value.trim();
      if (!/^\d{5}$/.test(pinInput)) {
        return alert("–í–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π PIN");
      }

      const entry = history.find(h => h.pin === pinInput);
      if (!entry) {
        return alert("–ö–ª–∏–µ–Ω—Ç —Å —Ç–∞–∫–∏–º PIN –Ω–µ –Ω–∞–π–¥–µ–Ω");
      }

      currentContactLink = entry.contact;
      currentPin = entry.pin;

      const addPoints = settings.pointsPerOp;
      let newPoints = entry.newPoints + addPoints;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω–µ–π (—Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö!)
      let promoLevel = null, discount = 0, reset = false;
      if (newPoints >= settings.levels[2].threshold) { // 30
        promoLevel = '30'; discount = settings.levels[2].discount;
        reset = true;
        newPoints = 0;
      } else if (newPoints >= settings.levels[1].threshold) { // 25
        promoLevel = '20'; discount = settings.levels[1].discount;
      } else if (newPoints >= settings.levels[0].threshold) { // 15
        promoLevel = '5'; discount = settings.levels[0].discount;
      }

      addToHistory(entry.id, entry.newPoints, newPoints, entry.contact, entry.pin);

      const newQrStr = encodeToQRString(entry.id, newPoints);
      document.getElementById('result-qr-img').innerHTML = generateQRImage(newQrStr);
      document.getElementById('result-qr-display').classList.remove('hidden');

      const promoDiv = document.getElementById('promo-notification');
      promoDiv.className = 'promo-alert hidden';
      if (promoLevel) {
        promoDiv.innerText = `üéÅ –î–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ ${discount}% —Å–∫–∏–¥–∫—É!`;
        promoDiv.classList.add(`level-${promoLevel}`);
        promoDiv.classList.remove('hidden');
        playSound();
      }

      document.getElementById('input-pin').value = '';
    }

    function resetPoints() {
      const pinInput = document.getElementById('input-pin').value.trim();
      if (!/^\d{5}$/.test(pinInput)) {
        return alert("–í–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π PIN –¥–ª—è –æ–±–Ω—É–ª–µ–Ω–∏—è");
      }

      const entry = history.find(h => h.pin === pinInput);
      if (!entry) {
        return alert("–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");
      }

      currentContactLink = entry.contact;
      currentPin = entry.pin;

      addToHistory(entry.id, entry.newPoints, 0, entry.contact, entry.pin);

      const newQrStr = encodeToQRString(entry.id, 0);
      document.getElementById('result-qr-img').innerHTML = generateQRImage(newQrStr);
      document.getElementById('result-qr-display').classList.remove('hidden');

      alert("‚úÖ –ë–∞–ª–ª—ã –æ–±–Ω—É–ª–µ–Ω—ã!");
      document.getElementById('input-pin').value = '';
    }
  </script>
</body>
</html>
