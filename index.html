<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–¥–º–∏–Ω–∫–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
    body {
      padding: 20px;
      background: #f5f7fa;
      color: #222;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h2 { margin: 20px 0 12px; }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      background: #2196F3;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    button.export-btn {
      background: #9c27b0;
      font-size: 14px;
      padding: 8px;
    }
    button.send-btn {
      background: #0088cc;
      font-size: 14px;
      padding: 8px;
      margin-top: 10px;
    }
    .section { background: white; padding: 16px; border-radius: 12px; margin-top: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .hidden { display: none !important; }
    .promo-alert {
      padding: 14px;
      border-radius: 8px;
      margin: 16px 0;
      font-weight: bold;
      text-align: center;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .level-20 { background: #e3f2fd; color: #0d47a1; }
    .level-25 { background: #fff8e1; color: #e65100; }
    .level-30 { background: #e8f5e8; color: #1b5e20; }
    .footer-note { text-align: center; font-size: 12px; color: #888; margin-top: 20px; }
    .pin-display {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: #2196F3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéüÔ∏è –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</h1>

    <!-- –ù–û–í–´–ô –ö–õ–ò–ï–ù–¢ -->
    <div class="section">
      <h2>‚ûï –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</h2>
      <input type="text" id="contact-link" placeholder="Telegram (@user) –∏–ª–∏ VK (https://vk.com/user)" />
      <button onclick="generateNewUser()">–í—ã–¥–∞—Ç—å QR —Å 100 –±–∞–ª–ª–∞–º–∏</button>
      <div id="new-qr-display" class="hidden">
        <div class="pin-display">PIN: <span id="new-pin"></span></div>
        <h3>QR –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:</h3>
        <div id="new-qr-img"></div>
        <button class="send-btn" onclick="sendToClient('new')">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É</button>
        <p style="font-size:12px;color:#666;margin-top:8px;">–°–æ–æ–±—â–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—É –µ–≥–æ 5-–∑–Ω–∞—á–Ω—ã–π PIN.</p>
      </div>
    </div>

    <!-- –ù–ê–ß–ò–°–õ–ï–ù–ò–ï –ë–ê–õ–õ–û–í -->
    <div class="section">
      <h2>üîÑ –ù–∞—á–∏—Å–ª–∏—Ç—å 5 –±–∞–ª–ª–æ–≤</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π PIN –∫–ª–∏–µ–Ω—Ç–∞:</p>
      <input type="text" id="input-pin" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 48291" maxlength="5" />
      <button onclick="addPointsByPin()">–î–æ–±–∞–≤–∏—Ç—å 5 –±–∞–ª–ª–æ–≤</button>

      <div id="promo-notification" class="hidden"></div>

      <div id="result-qr-display" class="hidden">
        <h3>–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π QR:</h3>
        <div id="result-qr-img"></div>
        <button class="send-btn" onclick="sendToClient('result')">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É</button>
      </div>
    </div>

    <!-- –≠–ö–°–ü–û–†–¢ -->
    <div style="text-align:center; margin-top:20px;">
      <button class="export-btn" onclick="exportHistory()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏</button>
    </div>

    <div class="footer-note">
      –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.
    </div>
  </div>

  <!-- QR Generator -->
  <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
  <script>
    const SECRET = "loyalty-secret-2026";
    let history = JSON.parse(localStorage.getItem('loyalty_history') || '[]');
    let currentContactLink = null;
    let currentPin = null;

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ 5-–∑–Ω–∞—á–Ω–æ–≥–æ PIN
    function generateUniquePin() {
      let pin;
      do {
        pin = Math.floor(10000 + Math.random() * 90000).toString(); // 10000‚Äì99999
      } while (history.some(h => h.pin === pin));
      return pin;
    }

    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
    function makeHash(id, points) {
      return btoa(`${id}|${points}|${SECRET}`).replace(/[^a-zA-Z0-9]/g, '').substring(0, 12).toUpperCase();
    }

    function encodeToQRString(id, points) {
      return `id:${id}|points:${points}|hash:${makeHash(id, points)}`;
    }

    function generateQRImage(str) {
      const qr = qrcode(0, 'M');
      qr.addData(str);
      qr.make();
      return qr.createImgTag(6);
    }

    function playSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        oscillator.frequency.value = 800;
        gainNode.gain.value = 0.2;
        oscillator.type = 'sine';
        oscillator.start();
        setTimeout(() => oscillator.stop(), 200);
      } catch (e) {}
    }

    function addToHistory(id, oldPoints, newPoints, contact = '', pin = '') {
      history.unshift({ time: new Date().toISOString(), id, oldPoints, newPoints, contact, pin });
      if (history.length > 500) history = history.slice(0, 500);
      localStorage.setItem('loyalty_history', JSON.stringify(history));
    }

    function exportHistory() {
      let txt = "–ò—Å—Ç–æ—Ä–∏—è\n=======\n\n";
      history.forEach(item => {
        const date = new Date(item.time).toLocaleString('ru-RU');
        txt += `${date} | PIN: ${item.pin} | ${item.contact || '‚Äî'} | ID: ${item.id} | ${item.oldPoints} ‚Üí ${item.newPoints}\n`;
      });
      const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `loyalty_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function saveQRAsFile(imgElement) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const img = new Image();
      img.src = imgElement.src;
      
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `loyalty_qr_${new Date().getTime()}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 'image/png');
      };
    }

    function sendToClient(type) {
      const imgElement = document.querySelector(`#${type}-qr-img img`);
      if (!imgElement) return alert("QR –Ω–µ –Ω–∞–π–¥–µ–Ω");

      saveQRAsFile(imgElement);

      if (currentContactLink) {
        let url = '';
        if (currentContactLink.startsWith('@')) {
          const username = currentContactLink.replace(/^@/, '');
          url = `https://t.me/${username}`;
        } else if (currentContactLink.includes('vk.com')) {
          const vkId = currentContactLink.split('/').pop();
          url = `https://vk.com/im?sel=${vkId}`;
        }
        if (url) window.open(url, '_blank');
      }

      setTimeout(() => {
        alert("‚úÖ QR —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ —Ñ–∞–π–ª!\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –∫–ª–∏–µ–Ω—Ç—É.");
      }, 300);
    }

    // === –ì–ï–ù–ï–†–ê–¶–ò–Ø –ù–û–í–û–ì–û –ö–õ–ò–ï–ù–¢–ê ===
    function generateNewUser() {
      const contact = document.getElementById('contact-link').value.trim();
      if (!contact) return alert("–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç");

      currentContactLink = contact;
      const id = Math.random().toString(36).substring(2, 10) + Date.now().toString(36).slice(-4);
      const pin = generateUniquePin();
      const points = 100;
      const qrStr = encodeToQRString(id, points);

      document.getElementById('new-pin').innerText = pin;
      document.getElementById('new-qr-img').innerHTML = generateQRImage(qrStr);
      document.getElementById('new-qr-display').classList.remove('hidden');

      addToHistory(id, 0, points, contact, pin);
    }

    // === –ù–ê–ß–ò–°–õ–ï–ù–ò–ï –ü–û PIN ===
    function addPointsByPin() {
      const pinInput = document.getElementById('input-pin').value.trim();
      if (!/^\d{5}$/.test(pinInput)) {
        return alert("–í–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π PIN");
      }

      const entry = history.find(h => h.pin === pinInput);
      if (!entry) {
        return alert("–ö–ª–∏–µ–Ω—Ç —Å —Ç–∞–∫–∏–º PIN –Ω–µ –Ω–∞–π–¥–µ–Ω");
      }

      currentContactLink = entry.contact;
      currentPin = entry.pin;

      const newPoints = entry.newPoints + 5; // –≤—Å–µ–≥–¥–∞ –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–∞–ª–∞–Ω—Å
      addToHistory(entry.id, entry.newPoints, newPoints, entry.contact, entry.pin);

      const newQrStr = encodeToQRString(entry.id, newPoints);
      document.getElementById('result-qr-img').innerHTML = generateQRImage(newQrStr);
      document.getElementById('result-qr-display').classList.remove('hidden');

      // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–º–æ–∫–æ–¥–µ
      const promoDiv = document.getElementById('promo-notification');
      promoDiv.className = 'promo-alert hidden';
      let level = null, discount = 0;
      if (newPoints >= 100) { level = '30'; discount = 30; }
      else if (newPoints >= 75) { level = '25'; discount = 25; }
      else if (newPoints >= 50) { level = '20'; discount = 20; }

      if (level) {
        promoDiv.innerText = `üéÅ –î–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ ${discount}% —Å–∫–∏–¥–∫—É!`;
        promoDiv.classList.add(`level-${level}`);
        promoDiv.classList.remove('hidden');
        playSound();
      }

      document.getElementById('input-pin').value = '';
    }
  </script>
</body>
</html>
