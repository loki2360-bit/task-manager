<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–õ–æ—è–ª—å–Ω–æ—Å—Ç—å</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    body {
      padding: 20px;
      background: #f9f9f9;
      color: #333;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h2 { margin: 16px 0; }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      background: #4A90E2;
      color: white;
      border: none;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    button:hover { opacity: 0.9; }
    button.small {
      width: auto;
      padding: 6px 12px;
      font-size: 14px;
      display: inline-block;
      margin-left: 8px;
    }
    #qr-code img { display: block; margin: 16px auto; max-width: 200px; }
    .hidden { display: none !important; }
    .promo { 
      background: #fff8e1; 
      padding: 12px; 
      border-radius: 8px; 
      margin-top: 12px;
      font-weight: bold;
      color: #e65100;
    }
    .admin-section { background: #f0f7ff; padding: 16px; border-radius: 8px; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- –ö–õ–ò–ï–ù–¢–°–ö–ò–ô –í–ò–î–ñ–ï–¢ -->
    <div id="client-view">
      <h2>üì± –í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω</h2>
      <input id="phone" type="tel" placeholder="+7 (999) 123-45-67" />
      <button onclick="showQR()">–ü–æ–ª—É—á–∏—Ç—å QR-–∫–æ–¥</button>
      <div id="qr-code"></div>
      <div id="promo-hint" class="promo hidden"></div>
    </div>

    <!-- –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ -->
    <button onclick="toggleMode()" style="background:#666;">–ê–¥–º–∏–Ω–∫–∞ / –ö–ª–∏–µ–Ω—Ç</button>

    <!-- –ê–î–ú–ò–ù–ö–ê -->
    <div id="admin-panel" class="hidden">
      <h2>üîê –ê–¥–º–∏–Ω–∫–∞</h2>
      <input id="admin-pin" type="password" placeholder="PIN (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1234)" />
      <button onclick="unlockAdmin()">–í–æ–π—Ç–∏</button>

      <div id="admin-content" class="hidden admin-section">
        <h3>üîç –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        <p>–í–≤–µ–¥–∏—Ç–µ ID –∏–∑ QR-–∫–æ–¥–∞ (—á–∞—Å—Ç—å –ø–æ—Å–ª–µ LOYALTY:)</p>
        <input id="manual-id" placeholder="abc123..." />
        <button onclick="loadUserById()">–ù–∞–π—Ç–∏</button>

        <div id="user-info" class="hidden">
          <h3>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
          <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="user-phone"></span></p>
          <p><strong>–ë–∞–ª–ª—ã:</strong> <span id="user-points">0</span></p>
          <div id="current-promo" class="promo hidden"></div>

          <h4>¬± –ë–∞–ª–ª—ã</h4>
          <input id="points-change" type="number" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 100 –∏–ª–∏ -50" />
          <button onclick="applyPoints()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>

          <h4 style="margin-top:20px;">üì§ –≠–∫—Å–ø–æ—Ä—Ç</h4>
          <button onclick="exportData('txt')">–°–∫–∞—á–∞—Ç—å TXT</button>
          <button onclick="exportData('json')">–°–∫–∞—á–∞—Ç—å JSON</button>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Generator -->
  <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
  <script>
    // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
    const ADMIN_PIN = "1234"; // ‚Üê –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô!
    let users = JSON.parse(localStorage.getItem('loyalty_users') || '{}');

    // === –ö–õ–ò–ï–ù–¢: –ì–ï–ù–ï–†–ê–¶–ò–Ø QR ===
    function showQR() {
      const phone = document.getElementById('phone').value.trim().replace(/\D/g, '');
      if (!phone || phone.length < 10) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω");
      const cleanPhone = '+' + phone;

      if (!users[cleanPhone]) {
        users[cleanPhone] = {
          points: 0,
          id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
          promo500: null, // {code, expires}
          promo1000: null  // {code, expires} ‚Äî –±–µ—Å—Å—Ä–æ—á–Ω—ã–π
        };
        saveUsers();
      }

      const userId = users[cleanPhone].id;
      const qrData = `LOYALTY:${userId}`;
      const qr = qrcode(0, 'M');
      qr.addData(qrData);
      qr.make();
      document.getElementById('qr-code').innerHTML = qr.createImgTag(5);

      // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –æ –ø—Ä–æ–º–æ–∫–æ–¥–∞—Ö
      checkAndShowPromoHint(cleanPhone);
    }

    function checkAndShowPromoHint(phone) {
      const el = document.getElementById('promo-hint');
      el.classList.add('hidden');
      const u = users[phone];
      if (u.promo1000) {
        el.innerText = `üéÅ –£ –≤–∞—Å –µ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ 30%: ${u.promo1000.code}`;
        el.classList.remove('hidden');
      } else if (u.promo500 && new Date(u.promo500.expires) > new Date()) {
        el.innerText = `üéÅ –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ 5%: ${u.promo500.code} (–¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ ${new Date(u.promo500.expires).toLocaleDateString()})`;
        el.classList.remove('hidden');
      }
    }

    // === –ê–î–ú–ò–ù–ö–ê ===
    function toggleMode() {
      const client = document.getElementById('client-view');
      const admin = document.getElementById('admin-panel');
      if (client.classList.contains('hidden')) {
        client.classList.remove('hidden');
        admin.classList.add('hidden');
      } else {
        client.classList.add('hidden');
        admin.classList.remove('hidden');
      }
    }

    function unlockAdmin() {
      const pin = document.getElementById('admin-pin').value;
      if (pin === ADMIN_PIN) {
        document.getElementById('admin-content').classList.remove('hidden');
      } else {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π PIN");
      }
    }

    function loadUserById() {
      const id = document.getElementById('manual-id').value.trim();
      if (!id) return alert("–í–≤–µ–¥–∏—Ç–µ ID");
      
      let found = null;
      for (let phone in users) {
        if (users[phone].id === id) {
          found = { phone, ...users[phone] };
          break;
        }
      }

      if (!found) {
        alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
        document.getElementById('user-info').classList.add('hidden');
        return;
      }

      document.getElementById('user-phone').innerText = found.phone;
      document.getElementById('user-points').innerText = found.points;
      document.getElementById('user-info').classList.remove('hidden');

      // –ü–æ–∫–∞–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞
      const promoEl = document.getElementById('current-promo');
      promoEl.classList.add('hidden');
      if (found.promo1000) {
        promoEl.innerText = `30% –ø—Ä–æ–º–æ–∫–æ–¥: ${found.promo1000.code} (–±–µ—Å—Å—Ä–æ—á–Ω—ã–π)`;
        promoEl.classList.remove('hidden');
      } else if (found.promo500 && new Date(found.promo500.expires) > new Date()) {
        promoEl.innerText = `5% –ø—Ä–æ–º–æ–∫–æ–¥: ${found.promo500.code} (–¥–æ ${new Date(found.promo500.expires).toLocaleDateString()})`;
        promoEl.classList.remove('hidden');
      }
    }

    function applyPoints() {
      const phone = document.getElementById('user-phone').innerText;
      const change = parseInt(document.getElementById('points-change').value);
      if (isNaN(change)) return alert("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ");

      users[phone].points += change;
      if (users[phone].points < 0) users[phone].points = 0;

      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
      checkPromoConditions(phone);

      saveUsers();
      document.getElementById('user-points').innerText = users[phone].points;
      alert(`–ë–∞–ª–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã! –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${users[phone].points}`);
      loadUserById(); // –æ–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    }

    function checkPromoConditions(phone) {
      const u = users[phone];
      const now = new Date();

      // 500 ‚Üí 5% –Ω–∞ 2 –¥–Ω—è
      if (u.points >= 500 && !u.promo500) {
        const code = "LOYAL5-" + Math.random().toString(36).substring(2, 8).toUpperCase();
        const expires = new Date(now);
        expires.setDate(expires.getDate() + 2);
        u.promo500 = { code, expires: expires.toISOString() };
      }

      // 1000 ‚Üí 30% –Ω–∞–≤—Å–µ–≥–¥–∞
      if (u.points >= 1000 && !u.promo1000) {
        const code = "LOYAL30-" + Math.random().toString(36).substring(2, 8).toUpperCase();
        u.promo1000 = { code, expires: null };
      }
    }

    function saveUsers() {
      localStorage.setItem('loyalty_users', JSON.stringify(users));
    }

    // === –≠–ö–°–ü–û–†–¢ ===
    function exportData(format) {
      let dataStr, filename;
      if (format === 'txt') {
        let txt = "";
        for (let phone in users) {
          const u = users[phone];
          txt += `–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n`;
          txt += `–ë–∞–ª–ª—ã: ${u.points}\n`;
          if (u.promo500) txt += `–ü—Ä–æ–º–æ 5%: ${u.promo500.code} (–¥–æ ${new Date(u.promo500.expires).toLocaleDateString()})\n`;
          if (u.promo1000) txt += `–ü—Ä–æ–º–æ 30%: ${u.promo1000.code} (–±–µ—Å—Å—Ä–æ—á–Ω—ã–π)\n`;
          txt += "---\n";
        }
        dataStr = "data:text/plain;charset=utf-8," + encodeURIComponent(txt);
        filename = `loyalty_${new Date().toISOString().slice(0,10)}.txt`;
      } else {
        dataStr = "data:application/json;charset=utf-8," + encodeURIComponent(JSON.stringify(users, null, 2));
        filename = `loyalty_${new Date().toISOString().slice(0,10)}.json`;
      }

      const link = document.createElement("a");
      link.setAttribute("href", dataStr);
      link.setAttribute("download", filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.onload = () => {
      document.getElementById('admin-panel').classList.add('hidden');
    };
  </script>
</body>
</html>
